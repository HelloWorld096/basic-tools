<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>C Editor</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">

<style>
body {
  margin: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: #121212;
  color: #fff;
  font-family: system-ui, sans-serif;
}


/* Toolbar */
.toolbar {
  display: flex;
  gap: 8px;
  padding: 10px;
  background: #1b1b1b;
}

.toolbar button {
  flex: 1;
  padding: 10px;
  font-size: 14px;
  border: none;
  cursor: pointer;
}

.btn-save { background: #305CDE; color: #fff; }
.btn-run  { background: #1f8f3a; color: #fff; }
.btn-set  { background: #305CDE; color: #fff; }

/* Tabs */
.tabs {
  display: flex;
  background: #181818;
  overflow-x: auto;
}

.tab {
  display: flex;
  align-items: center;
  padding: 8px 10px;
  border-right: 1px solid #333;
  cursor: pointer;
}

.tab.active { background: #2a2a2a; }

.tab span {
  margin-left: 8px;
  cursor: pointer;
}

.tab.add {
  font-weight: bold;
}

/* Editor */
.editor { flex: 1; }

.CodeMirror {
  height: 100%;
  font-size: 14px;
}

/* Modal */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.8);
  display: none;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: #1e1e1e;
  padding: 16px;
  width: 90%;
  max-width: 420px;
}

.modal-content input {
  width: 95%;
  margin-bottom: 10px;
  padding: 8px;
}

.modal-content h3 {
  margin-top: 0;
  margin-bottom: 12px;
  font-size: 16px;
}

.modal-content button {
  width: 100%;
  padding: 10px;
  background: #1f8f3a;
  color: #fff;
  border: none;
  cursor: pointer;
}



/* Output */
.output {
  position: fixed;
  inset: 0;
  background: #000;
  display: none;
  flex-direction: column;
}

.output pre {
  flex: 1;
  padding: 12px;
  overflow: auto;
}

#backBtn {
padding: 10px;
  font-size: 14px;
  border: none;
  cursor: pointer;
height=20px;
background: #305CDE; 
color: #fff;
}
</style>
</head>
<body>

<div class="toolbar">
  <button class="btn-save" onclick="saveFile()">Save</button>
  <button class="btn-run" onclick="runCode()">Run</button>
  <button class="btn-set" onclick="openSettings()">Settings</button>
</div>

<div class="tabs" id="tabs"></div>

<div class="editor">
  <textarea id="code"></textarea>
</div>

<!-- Settings -->
<div class="modal" id="settingsModal">
  <div class="modal-content">
    <h3>Settings</h3>
    <input id="endpoint" placeholder="Endpoint">
    <input id="path" placeholder="Default path">
    <button onclick="saveSettings()">Save</button>
  </div>
</div>

<!-- Output -->
<div class="output" id="output">
  <button id="backBtn" onclick="closeOutput()">Back</button>
  <pre id="outputText"></pre>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>

<script>
const editor = CodeMirror.fromTextArea(code, {
  mode: "text/x-csrc",
  theme: "material-darker",
  lineNumbers: true,
  autoCloseBrackets: true,
  matchBrackets: true,
  indentUnit: 4
});

let tabs = JSON.parse(localStorage.getItem("tabs") || "[]");
let activeIndex = Number(localStorage.getItem("activeTab") || 0);

/* ---------- SETTINGS (FRONTEND ONLY) ---------- */

function openSettings() {
  endpoint.value = localStorage.getItem("endpoint") || "http://localhost:5000";
  path.value = localStorage.getItem("path") || "";
  settingsModal.style.display = "flex";
}

function saveSettings() {
  localStorage.setItem("endpoint", endpoint.value);
  localStorage.setItem("path", path.value);
  settingsModal.style.display = "none";
}

/* ---------- TABS ---------- */

function addTab() {
  const name = prompt("Enter file name (with extension)");
  if (!name || !name.includes(".")) return;

  tabs.push({ name, content: "" });
  activeIndex = tabs.length - 1;
  persist();

  send("open", {
    file: name,
    path: localStorage.getItem("path") || "default"
  });

  renderTabs();
  editor.setValue("");
}

function selectTab(i) {
  saveLocal();
  activeIndex = i;
  editor.setValue(tabs[i].content);
  persist();
  renderTabs();
}

function closeTab(i) {
  tabs.splice(i, 1);
  activeIndex = Math.max(0, activeIndex - 1);
  persist();
  renderTabs();
  editor.setValue(tabs[activeIndex]?.content || "");
}

function renderTabs() {
  const t = document.getElementById("tabs");
  t.innerHTML = '<div class="tab add" onclick="addTab()">+</div>';

  tabs.forEach((tab, i) => {
    const el = document.createElement("div");
    el.className = "tab" + (i === activeIndex ? " active" : "");
    el.innerHTML = `${tab.name}<span onclick="closeTab(${i})">Ã—</span>`;
    el.onclick = () => selectTab(i);
    t.appendChild(el);
  });
}

/* ---------- SAVE ---------- */

function saveLocal() {
  if (!tabs.length) return;
  tabs[activeIndex].content = editor.getValue();
  persist();
}

function saveFile() {
  if (!tabs.length) return;
  saveLocal();

  send("save", {
    file: tabs[activeIndex].name,
    code: tabs[activeIndex].content
  });
}

/* ---------- RUN ---------- */

function runCode() {
  if (!tabs.length) return;

  /* 1. Save locally */
  saveLocal();

  /* 2. Send save request */
  send("save", {
    file: tabs[activeIndex].name,
    code: tabs[activeIndex].content
  });

  /* 3. Send run request */
  send("run", {
    file: tabs[activeIndex].name
  });

  /* 4. Show output screen */
  outputText.textContent = "Running...\nWaiting for output...";
  output.style.display = "flex";
}

/* ---------- OUTPUT ---------- */

function closeOutput() {
  output.style.display = "none";
}

/* ---------- STORAGE ---------- */

function persist() {
  localStorage.setItem("tabs", JSON.stringify(tabs));
  localStorage.setItem("activeTab", activeIndex);
}

/* ---------- REQUEST ---------- */

function send(action, data) {
  const ep = localStorage.getItem("endpoint");
  if (!ep) return;

  fetch(ep + "/" + action, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  }).catch(() => {});
}

/* ---------- INIT ---------- */

if (tabs.length) {
  renderTabs();
  editor.setValue(tabs[activeIndex]?.content || "");
} else {
  renderTabs();
}
</script>


</body>
</html>
